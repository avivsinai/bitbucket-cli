name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v6
        with:
          go-version: '1.24'

      - name: Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sudo sh -s -- -b /usr/local/bin

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  darwin:
    runs-on: macos-latest
    needs: release
    strategy:
      matrix:
        include:
          - goarch: amd64
            arch_name: x86_64
          - goarch: arm64
            arch_name: arm64
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v6
        with:
          go-version: '1.24'

      - name: Get version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build darwin binary
        env:
          CGO_ENABLED: 1
          GOOS: darwin
          GOARCH: ${{ matrix.goarch }}
        run: |
          go build -trimpath \
            -ldflags "-s -w \
              -X github.com/avivsinai/bitbucket-cli/internal/build.versionFromLdflags=${{ steps.version.outputs.version }} \
              -X github.com/avivsinai/bitbucket-cli/internal/build.commitFromLdflags=${{ github.sha }} \
              -X github.com/avivsinai/bitbucket-cli/internal/build.dateFromLdflags=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            -o bkt \
            ./cmd/bkt

      - name: Create archive
        run: |
          mkdir -p dist
          tar -czvf dist/bkt_${{ steps.version.outputs.version }}_darwin_${{ matrix.arch_name }}.tar.gz \
            bkt README.md LICENSE CHANGELOG.md

      - name: Generate SBOM
        run: |
          brew install syft
          syft dir:. -o cyclonedx-json=dist/bkt_${{ steps.version.outputs.version }}_darwin_${{ matrix.arch_name }}.tar.gz.sbom.cdx.json

      - name: Upload to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload v${{ steps.version.outputs.version }} \
            dist/bkt_${{ steps.version.outputs.version }}_darwin_${{ matrix.arch_name }}.tar.gz \
            dist/bkt_${{ steps.version.outputs.version }}_darwin_${{ matrix.arch_name }}.tar.gz.sbom.cdx.json \
            --clobber

  update-checksums:
    runs-on: ubuntu-latest
    needs: darwin
    steps:
      - uses: actions/checkout@v6

      - name: Get version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download all release assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p dist
          gh release download v${{ steps.version.outputs.version }} -D dist

      - name: Regenerate checksums
        run: |
          cd dist
          rm -f checksums.txt
          sha256sum *.tar.gz *.zip *.deb 2>/dev/null | sort > checksums.txt

      - name: Upload updated checksums
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload v${{ steps.version.outputs.version }} dist/checksums.txt --clobber
