name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  pull-requests: write

# Prevent race conditions: only one release per tag, cancel stale runs
concurrency:
  group: release-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  release:
    runs-on: macos-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v6
        with:
          go-version: '1.24'

      - name: Install Syft
        run: brew install syft

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: '~> v2'
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOMEBREW_TAP_GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}

  publish-skill:
    runs-on: ubuntu-latest
    needs: release
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install skild
        run: npm install -g skild

      - name: Configure skild auth
        run: |
          mkdir -p ~/.skild
          echo '${{ secrets.SKILD_AUTH_JSON }}' > ~/.skild/registry-auth.json

      - name: Get next version from registry
        id: version
        run: |
          # Query the registry API for latest published version
          # distTags may be an array of {tag,version} or an object {latest:"x.y.z"}
          REGISTRY_JSON=$(curl -sf "https://registry.skild.sh/skills/avivsinai/bkt?include=versions" || true)
          REGISTRY_VERSION=$(echo "$REGISTRY_JSON" \
            | jq -r '(.distTags | if type == "array" then [.[]|select(.tag=="latest")][0].version else .latest end) // empty' 2>/dev/null || true)

          if [ -n "$REGISTRY_VERSION" ]; then
            echo "Found registry version: $REGISTRY_VERSION"
            CURRENT="$REGISTRY_VERSION"
          else
            echo "No registry version found, using SKILL.md"
            CURRENT=$(grep -oP 'version:\s*\K[\d.]+' skills/bkt/SKILL.md)
          fi

          MAJOR=$(echo $CURRENT | cut -d. -f1)
          MINOR=$(echo $CURRENT | cut -d. -f2)
          PATCH=$(echo $CURRENT | cut -d. -f3)
          NEXT="$MAJOR.$MINOR.$((PATCH + 1))"

          echo "version=$NEXT" >> $GITHUB_OUTPUT
          echo "Publishing: $CURRENT -> $NEXT"

      - name: Publish skill
        run: |
          npx skild publish \
            --dir skills/bkt \
            --alias bkt \
            --alias bitbucket-cli \
            --skill-version ${{ steps.version.outputs.version }}

      - name: Update SKILL.md versions
        run: |
          VERSION=${{ steps.version.outputs.version }}
          for file in skills/bkt/SKILL.md .claude/skills/bkt/SKILL.md .codex/skills/bkt/SKILL.md; do
            if [ -f "$file" ]; then
              sed -i "s/^version: .*/version: $VERSION/" "$file"
            fi
          done

      - name: Create version bump PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ steps.version.outputs.version }}

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create branch and commit
          git checkout -b chore/skill-version-bump
          git add skills/bkt/SKILL.md .claude/skills/bkt/SKILL.md .codex/skills/bkt/SKILL.md
          git diff --staged --quiet && echo "No changes to commit" && exit 0
          git commit -m "chore(skill): update version to ${VERSION} [skip ci]"
          git push -f origin chore/skill-version-bump

          # Create PR and try to auto-merge; if branch protection blocks it,
          # leave the PR open for a maintainer to merge
          PR_URL=$(gh pr create \
            --title "chore(skill): bump SKILL.md to ${VERSION}" \
            --body "Auto-generated after publishing \`@avivsinai/bkt@${VERSION}\` to the skill registry." \
            --base master \
            --head chore/skill-version-bump)

          gh pr merge "$PR_URL" --squash --admin --delete-branch \
            || echo "Auto-merge not available â€” PR left open for maintainer: $PR_URL"
